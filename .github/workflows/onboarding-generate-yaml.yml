name: Generate Onboarding YAML

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write

jobs:
  extract_and_generate_yaml:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # ------------------------------
      # 1. Extract issue form values
      # ------------------------------
      - name: Extract Issue Form Values
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body || "";

            // escape regex-special chars for the field name
            function escapeRegex(s) {
              return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }

            function get(field) {
              // match either "Field: value" or "Field | value" or "Field |value"
              const re = new RegExp(escapeRegex(field) + '\\s*(?:[:|])\\s*([^\\n\\r]+)', 'i');
              const match = body.match(re);
              return match ? match[1].trim().replace(/`/g, "") : "";
            }

            const data = {
              hospital_name: get("Hospital Name"),
              sales_order: get("Sales Order Number"),
              cpu: get("CPU (cores)"),
              memory: get("Memory (Gi)"),
              storage: get("Storage (Gi)"),
              namespace: get("Namespace"),
              frequency: get("Deployment Frequency"),
              timestamp: new Date().toISOString()
            };

            // Return JSON string so it's available as steps.extract.outputs.result
            return JSON.stringify(data);

      # ------------------------------
      # 2. Generate YAML file
      # ------------------------------
      - name: Create YAML file
        run: |
          # ensure jq is available
          apt-get update && apt-get install -y jq

          mkdir -p onboarding

          # write the JSON returned by github-script to a file (safer quoting)
          echo '${{ steps.extract.outputs.result }}' > onboarding/data.json

          RAW_HOSPITAL=$(jq -r '.hospital_name' onboarding/data.json)

          if [ -z "$RAW_HOSPITAL" ] || [ "$RAW_HOSPITAL" == "null" ]; then
            echo "ERROR: Hospital name is empty. Cannot create file."
            exit 1
          fi

          # Sanitize filename: lowercase, replace spaces with hyphens, remove symbols except - and _
          SAFE_HOSPITAL=$(echo "$RAW_HOSPITAL" | tr '[:upper:]' '[:lower:]' | sed 's/ /-/g' | sed 's/[^a-z0-9_-]//g')

          FILE="onboarding/${SAFE_HOSPITAL}.yaml"

          echo "Creating file: $FILE"

          # Use jq to safely extract fields into the YAML file
          cat > "$FILE" <<EOF
          hospital_name: "$(jq -r '.hospital_name' onboarding/data.json)"
          sales_order: "$(jq -r '.sales_order' onboarding/data.json)"
          namespace: "$(jq -r '.namespace' onboarding/data.json)"
          cpu: "$(jq -r '.cpu' onboarding/data.json)"
          memory: "$(jq -r '.memory' onboarding/data.json)"
          storage: "$(jq -r '.storage' onboarding/data.json)"
          frequency: "$(jq -r '.frequency' onboarding/data.json)"
          generated_at: "$(jq -r '.timestamp' onboarding/data.json)"
          EOF

      # ------------------------------
      # 3. Commit YAML file
      # ------------------------------
      - name: Commit & Push YAML
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Generated onboarding YAML for issue #${{ github.event.issue.number }}"
          file_pattern: onboarding/*.yaml

      # ------------------------------
      # 4. Reset labels
      # ------------------------------
      - name: Clear all labels on issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.removeAllLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

      # ------------------------------
      # 5. Final confirmation comment
      # ------------------------------
      - name: Comment confirmation
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: "ðŸ“ YAML file successfully generated in the `/onboarding/` folder.\n\nNext step: Approval workflow coming soon."
            })
