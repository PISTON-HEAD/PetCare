name: Generate Onboarding YAML

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # ----------------------------------------------------
      # 1. Extract issue form values from Markdown body
      # ----------------------------------------------------
      - name: Extract Issue Form Values
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body || "";
            const lines = body.split("\n").map(l => l.trim());

            function getField(title) {
              const index = lines.findIndex(
                l => l.toLowerCase() === `### ${title}`.toLowerCase()
              );
              if (index === -1) return "";

              for (let i = index + 1; i < lines.length; i++) {
                if (lines[i].length > 0) {
                  return lines[i].replace(/`/g, "");
                }
              }
              return "";
            }

            const data = {
              hospital_name: getField("Hospital Name"),
              sales_order: getField("Sales Order Number (SO)"),
              cpu: getField("CPU Cores"),
              memory: getField("Memory (Gi)"),
              storage: getField("Storage (Gi)"),
              namespace: getField("Kubernetes Namespace"),
              environment: getField("Environment"),
              ports: getField("Inbound Ports (Optional)"),
              notes: getField("Additional Notes"),
              timestamp: new Date().toISOString()
            };

            // set output for use in later steps
            core.setOutput("json", JSON.stringify(data));

      # ----------------------------------------------------
      # 2. Generate YAML file safely
      # ----------------------------------------------------
      - name: Create YAML file
        run: |
          set -euo pipefail

          mkdir -p onboarding
          echo '${{ steps.extract.outputs.json }}' > onboarding/data.json

          RAW=$(jq -r '.hospital_name' onboarding/data.json)

          if [ -z "$RAW" ] || [ "$RAW" = "null" ]; then
            echo "ERROR: Hospital name is missing."
            exit 1
          fi

          SAFE=$(echo "$RAW" | tr '[:upper:]' '[:lower:]' | sed 's/ /-/g' | sed 's/[^a-z0-9_-]//g')
          FILE="onboarding/${SAFE}.yaml"

          echo "Generating: $FILE"

          # create the YAML with each value safely extracted via jq
          cat <<EOF > "$FILE"
          hospital_name: "$(jq -r '.hospital_name' onboarding/data.json)"
          sales_order: "$(jq -r '.sales_order' onboarding/data.json)"
          namespace: "$(jq -r '.namespace' onboarding/data.json)"
          cpu: "$(jq -r '.cpu' onboarding/data.json)"
          memory: "$(jq -r '.memory' onboarding/data.json)"
          storage: "$(jq -r '.storage' onboarding/data.json)"
          environment: "$(jq -r '.environment' onboarding/data.json)"
          ports: "$(jq -r '.ports' onboarding/data.json)"
          notes: "$(jq -r '.notes' onboarding/data.json)"
          generated_at: "$(jq -r '.timestamp' onboarding/data.json)"
          EOF

      # ----------------------------------------------------
      # 3. Commit generated YAML
      # ----------------------------------------------------
      - name: Commit YAML
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Generated onboarding YAML for issue #${{ github.event.issue.number }}"
          file_pattern: onboarding/*.yaml

      # ----------------------------------------------------
      # 4. Comment confirmation (shows summary to approver)
      # ----------------------------------------------------
      - name: Post Confirmation Comment
        uses: actions/github-script@v7
        env:
          EXTRACTED_JSON: ${{ steps.extract.outputs.json }}
        with:
          script: |
            const json = process.env.EXTRACTED_JSON || "{}";
            let data = {};
            try {
              data = JSON.parse(json);
            } catch (e) {
              data = {};
            }

            // apply sensible defaults for display
            const hospitalName = data.hospital_name || "Not provided";
            const salesOrder = data.sales_order || "Not provided";
            const cpu = data.cpu || "Not provided";
            const memory = data.memory || "Not provided";
            const storage = data.storage || "Not provided";
            const environment = data.environment || "Not provided";
            const namespace = data.namespace || "Not provided";
            const ports = data.ports || "None";
            const notes = data.notes || "None";
            const generatedAt = data.timestamp || new Date().toISOString();

            const summary = `
            ### üè• Onboarding Details Extracted
            
            **Hospital Name:** ${hospitalName}
            **Sales Order:** ${salesOrder}
            
            #### üîß Requirements
            - **CPU:** ${cpu}
            - **Memory:** ${memory}
            - **Storage:** ${storage}
            - **Environment:** ${environment}
            - **Namespace:** ${namespace}
            - **Ports:** ${ports}
            - **Notes:** ${notes}
            
            **Generated at:** ${generatedAt}
            
            ---
            
            ‚úÖ Onboarding YAML has been generated and stored in \`/onboarding/\`.
            
            You may now proceed with the approval workflow.
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: summary
            });

      # ----------------------------------------------------
      # 5. Mark YAML generation complete (IMPORTANT)
      # ----------------------------------------------------
      - name: Mark YAML generation as complete
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ["yaml-generated"]
            });
