name: Onboarding Approval Workflow

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write

jobs:
  approval:
    runs-on: ubuntu-latest

    # -------------------------------------------------------
    # Only run when:
    # - comment contains /approve
    # - issue has yaml-generated label
    # -------------------------------------------------------
    if: |
      github.event.issue.pull_request == null &&
      contains(github.event.comment.body, '/approve') &&
      contains(github.event.issue.labels.*.name, 'yaml-generated')

    steps:

      - name: Checkout repository
        uses: actions/checkout@v3

      # ----------------------------------------
      # 1. Load approver list WITHOUT yq or jq
      # ----------------------------------------
      - name: Load Approvers
        id: approvers
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");

            const file = "approvers/approvers.yaml";
            const raw = fs.readFileSync(file, "utf8");

            // Extract YAML list manually (simple format)
            const approvers = [];

            raw.split("\n").forEach(line => {
              const match = line.match(/-\s*(.+)/);
              if (match) approvers.push(match[1].trim());
            });

            console.log("Approvers loaded:", approvers);

            core.setOutput("list", JSON.stringify(approvers));

      # ----------------------------------------
      # 2. Validate if commenter is in approver list
      # ----------------------------------------
      - name: Validate Approver
        id: validate
        uses: actions/github-script@v7
        with:
          script: |
            const approvers = JSON.parse("${{ steps.approvers.outputs.list }}");
            const commenter = context.payload.comment.user.login;

            console.log("Commenter:", commenter);

            const authorized = approvers.includes(commenter);

            console.log("Authorized:", authorized);

            core.setOutput("authorized", authorized);

      # ----------------------------------------
      # 3. Reject unauthorized users
      # ----------------------------------------
      - name: Reject unauthorized user
        if: steps.validate.outputs.authorized == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: "⛔ **You are NOT authorized to approve this onboarding.**"
            });

            core.setFailed("User is not in approver list.");

      # ----------------------------------------
      # 4. Add approval label
      # ----------------------------------------
      - name: Add approval label
        if: steps.validate.outputs.authorized == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ["approved"]
            });

      # ----------------------------------------
      # 5. Post confirmation message
      # ----------------------------------------
      - name: Comment approval result
        if: steps.validate.outputs.authorized == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const timestamp = new Date().toISOString();
            const user = context.payload.comment.user.login;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `✅ **Approval Granted**\nApproved by **${user}** at **${timestamp}**.\n\nOnboarding will now proceed.`
            });
