name: Onboarding Approval Workflow

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write

jobs:
  approval:
    runs-on: ubuntu-latest

    if: |
      github.event.issue.pull_request == null &&
      contains(github.event.comment.body, '/approve') &&
      contains(github.event.issue.labels.*.name, 'yaml-generated')

    steps:

      - name: Checkout repository
        uses: actions/checkout@v3

      # ----------------------------------------
      # 1. Load approvers from YAML (no yq needed)
      # ----------------------------------------
      - name: Load Approvers
        id: load_approvers
        run: |
          echo "Reading approvers..."
          LIST=$(grep '-' approvers/approvers.yaml | sed 's/- //g' | tr '\n' ',' | sed 's/,$//')
          JSON=$(printf '[%s]' "$(echo $LIST | sed 's/,/","/g' | sed 's/^/"/; s/$/"/')")
          
          echo "APPROVERS_JSON=$JSON" >> $GITHUB_ENV
          echo "Loaded approvers: $JSON"

      # ----------------------------------------
      # 2. Validate if commenter is an approver
      # ----------------------------------------
      - name: Validate Approver
        id: validate
        uses: actions/github-script@v7
        with:
          script: |
            const approvers = JSON.parse(process.env.APPROVERS_JSON);
            const commenter = context.payload.comment.user.login;

            console.log("Approvers:", approvers);
            console.log("Commenter:", commenter);

            const authorized = approvers.includes(commenter);
            core.setOutput("authorized", authorized);

      # ----------------------------------------
      # 3. Reject unauthorized user
      # ----------------------------------------
      - name: Reject Unauthorized
        if: steps.validate.outputs.authorized == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: "⛔ **You are NOT authorized to approve this onboarding.**"
            });
            core.setFailed("Unauthorized approver");

      # ----------------------------------------
      # 4. Add approval label
      # ----------------------------------------
      - name: Add Approval Label
        if: steps.validate.outputs.authorized == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ["approved"]
            });

      # ----------------------------------------
      # 5. Add confirmation comment
      # ----------------------------------------
      - name: Approval Success Comment
        if: steps.validate.outputs.authorized == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const timestamp = new Date().toISOString();
            const user = context.payload.comment.user.login;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `✅ **Approval Granted**\nApproved by **${user}** at **${timestamp}**.\n\nOnboarding will now proceed.`
            });
