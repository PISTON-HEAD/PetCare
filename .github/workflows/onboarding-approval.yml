name: Onboarding Approval Workflow

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write

jobs:
  approval:
    runs-on: ubuntu-latest

    # -------------------------------------------------------
    # This MUST ONLY RUN after YAML generation workflow worked
    # -------------------------------------------------------
    if: |
      github.event.issue.pull_request == null &&
      contains(github.event.comment.body, '/approve') &&
      contains(github.event.issue.labels.*.name, 'yaml-generated')

    steps:

      - name: Checkout repository
        uses: actions/checkout@v3

      # ----------------------------------------
      # 1. Load approver list
      # ----------------------------------------
      - name: Read Approvers
        id: approvers
        run: |
          echo "APPROVERS=$(yq '.approvers' -o=json approvers/approvers.yaml)" >> $GITHUB_ENV

      # ----------------------------------------
      # 2. Validate if comment author is allowed
      # ----------------------------------------
      - name: Validate Approver
        id: validate
        run: |
          COMMENTER="${{ github.event.comment.user.login }}"
          echo "Commenter: $COMMENTER"

          echo "$APPROVERS" | jq -e --arg user "$COMMENTER" '.[] | select(. == $user)' > /dev/null

          if [ $? -ne 0 ]; then
            echo "UNAUTHORIZED=true" >> $GITHUB_ENV
          else
            echo "UNAUTHORIZED=false" >> $GITHUB_ENV
          fi

      # ----------------------------------------
      # 3. Handle unauthorized approvals
      # ----------------------------------------
      - name: Reject unauthorized user
        if: env.UNAUTHORIZED == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `⛔ You are NOT authorized to approve this onboarding.\n\nOnly designated approvers can use '/approve'.`
            });
            core.setFailed("Unauthorized approver")

      # ----------------------------------------
      # 4. Approve the onboarding request
      # ----------------------------------------
      - name: Add approval label
        if: env.UNAUTHORIZED == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ["approved"]
            });

      # ----------------------------------------
      # 5. Post approval confirmation
      # ----------------------------------------
      - name: Comment approval result
        if: env.UNAUTHORIZED == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const timestamp = new Date().toISOString();
            const user = context.payload.comment.user.login;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `✅ **Approval Granted**\nApproved by **${user}** at **${timestamp}**.\n\nOnboarding pipeline will now proceed.`
            });
